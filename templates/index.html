<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Smart Accounting - Accrual Basis</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tab-btn {
            padding: 12px 24px;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .tab-btn.active {
            background: white;
            color: #667eea;
            font-weight: bold;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .result-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .result-box.show {
            display: block;
        }

        .result-box.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
        }

        .result-box.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-card.green {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .stat-card.orange {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .stat-card.blue {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .stat-card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
        }

        .stat-card .unit {
            font-size: 0.8em;
            opacity: 0.8;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85em;
        }

        .tag-income {
            background: #d4edda;
            color: #155724;
        }

        .tag-expense {
            background: #fff3cd;
            color: #856404;
        }

        .tag-capital {
            background: #cce5ff;
            color: #004085;
        }

        .compare-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .compare-card {
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .compare-card.cash {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        .compare-card.accrual {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }

        .compare-card h4 {
            color: #333;
            margin-bottom: 15px;
        }

        .compare-card .amount {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
        }

        .compare-card .desc {
            color: #666;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .ai-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .hidden {
            display: none;
        }

        .month-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }

        .month-selector select {
            padding: 8px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }

        .insight-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .insight-box h4 {
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .compare-section {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            header h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>AI Smart Accounting</h1>
            <p>Accrual Basis - See Your True Living Cost</p>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('record')">Record</button>
            <button class="tab-btn" onclick="showTab('report')">Monthly Report</button>
            <button class="tab-btn" onclick="showTab('compare')">Compare Methods</button>
            <button class="tab-btn" onclick="showTab('assets')">My Assets</button>
            <button class="tab-btn" onclick="showTab('transactions')">Transactions</button>
        </div>

        <!-- Record Page -->
        <div id="tab-record" class="tab-content">
            <div class="card">
                <h2>Record Expense <span class="ai-badge">AI Powered</span></h2>
                <p style="color: #666; margin-bottom: 20px;">Enter expense description, AI will automatically determine if it's operating or capital expense and estimate useful life</p>

                <div class="form-group">
                    <label>Expense Description</label>
                    <input type="text" id="expense-desc" placeholder="e.g., bought a new wok, lunch at restaurant">
                </div>

                <div class="form-group">
                    <label>Amount ($)</label>
                    <input type="number" id="expense-amount" placeholder="300" step="0.01">
                </div>

                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="expense-date">
                </div>

                <button class="btn btn-primary" onclick="recordExpense()">AI Smart Record</button>

                <div id="expense-result" class="result-box"></div>
            </div>

            <div class="card">
                <h2>Record Income</h2>

                <div class="form-group">
                    <label>Income Description</label>
                    <input type="text" id="income-desc" placeholder="e.g., December salary">
                </div>

                <div class="form-group">
                    <label>Amount ($)</label>
                    <input type="number" id="income-amount" placeholder="5000" step="0.01">
                </div>

                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="income-date">
                </div>

                <button class="btn btn-primary" onclick="recordIncome()">Record Income</button>

                <div id="income-result" class="result-box"></div>
            </div>
        </div>

        <!-- Monthly Report -->
        <div id="tab-report" class="tab-content hidden">
            <div class="card">
                <h2>Monthly Financial Report</h2>

                <div class="month-selector">
                    <select id="report-year"></select>
                    <select id="report-month"></select>
                    <button class="btn btn-primary" onclick="loadReport()">View Report</button>
                </div>

                <div id="report-content">
                    <div class="loading">Select a month to view report</div>
                </div>
            </div>
        </div>

        <!-- Compare Page -->
        <div id="tab-compare" class="tab-content hidden">
            <div class="card">
                <h2>Cash Basis vs Accrual Basis</h2>
                <p style="color: #666; margin-bottom: 20px;">See the difference between two accounting methods</p>

                <div class="month-selector">
                    <select id="compare-year"></select>
                    <select id="compare-month"></select>
                    <button class="btn btn-primary" onclick="loadCompare()">Compare</button>
                </div>

                <div id="compare-content">
                    <div class="loading">Select a month to see comparison</div>
                </div>
            </div>
        </div>

        <!-- Assets Page -->
        <div id="tab-assets" class="tab-content hidden">
            <div class="card">
                <h2>My Assets</h2>
                <p style="color: #666; margin-bottom: 20px;">What are your belongings worth?</p>

                <div id="assets-summary" class="stats-grid"></div>

                <table id="assets-table">
                    <thead>
                        <tr>
                            <th>Asset Name</th>
                            <th>Original Cost</th>
                            <th>Current Value</th>
                            <th>Monthly Depreciation</th>
                            <th>Remaining Months</th>
                            <th>Purchase Date</th>
                        </tr>
                    </thead>
                    <tbody id="assets-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Transactions -->
        <div id="tab-transactions" class="tab-content hidden">
            <div class="card">
                <h2>Transaction History</h2>

                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Type</th>
                            <th>Category</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-tbody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Initialize date pickers
        document.getElementById('expense-date').valueAsDate = new Date();
        document.getElementById('income-date').valueAsDate = new Date();

        // Initialize year/month selectors
        function initYearMonth() {
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;

            ['report', 'compare'].forEach(prefix => {
                const yearSelect = document.getElementById(`${prefix}-year`);
                const monthSelect = document.getElementById(`${prefix}-month`);

                yearSelect.innerHTML = '';
                for (let y = currentYear; y >= currentYear - 2; y--) {
                    yearSelect.innerHTML += `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`;
                }

                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                monthSelect.innerHTML = '';
                for (let m = 1; m <= 12; m++) {
                    monthSelect.innerHTML += `<option value="${m}" ${m === currentMonth ? 'selected' : ''}>${months[m-1]}</option>`;
                }
            });
        }

        initYearMonth();

        // Switch tabs
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            event.target.classList.add('active');

            // Load data
            if (tabName === 'assets') loadAssets();
            if (tabName === 'transactions') loadTransactions();
            if (tabName === 'report') loadReport();
            if (tabName === 'compare') loadCompare();
        }

        // Record expense
        async function recordExpense() {
            const desc = document.getElementById('expense-desc').value;
            const amount = document.getElementById('expense-amount').value;
            const date = document.getElementById('expense-date').value;

            if (!desc || !amount) {
                showResult('expense-result', 'Please fill in all fields', false);
                return;
            }

            try {
                const res = await fetch('/api/expense', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description: desc, amount: parseFloat(amount), date: date })
                });

                const data = await res.json();

                if (data.success) {
                    let msg = data.data.message;
                    if (data.data.analysis) {
                        msg += `<br><br><strong>AI Analysis:</strong><br>`;
                        msg += `Type: ${data.data.analysis.is_capital ? 'Capital Expenditure' : 'Operating Expense'}<br>`;
                        msg += `Category: ${data.data.analysis.category}<br>`;
                        if (data.data.analysis.is_capital) {
                            msg += `Useful Life: ${data.data.analysis.useful_life_years} years<br>`;
                            msg += `Monthly Cost: $${data.data.impact.monthly_cost}<br>`;
                        }
                        msg += `Reasoning: ${data.data.analysis.reasoning}`;
                    }
                    showResult('expense-result', msg, true);

                    document.getElementById('expense-desc').value = '';
                    document.getElementById('expense-amount').value = '';
                } else {
                    showResult('expense-result', data.error, false);
                }
            } catch (e) {
                showResult('expense-result', 'Network error: ' + e.message, false);
            }
        }

        // Record income
        async function recordIncome() {
            const desc = document.getElementById('income-desc').value;
            const amount = document.getElementById('income-amount').value;
            const date = document.getElementById('income-date').value;

            if (!desc || !amount) {
                showResult('income-result', 'Please fill in all fields', false);
                return;
            }

            try {
                const res = await fetch('/api/income', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description: desc, amount: parseFloat(amount), date: date })
                });

                const data = await res.json();

                if (data.success) {
                    showResult('income-result', data.data.message, true);
                    document.getElementById('income-desc').value = '';
                    document.getElementById('income-amount').value = '';
                } else {
                    showResult('income-result', data.error, false);
                }
            } catch (e) {
                showResult('income-result', 'Network error: ' + e.message, false);
            }
        }

        // Show result
        function showResult(elementId, message, success) {
            const el = document.getElementById(elementId);
            el.innerHTML = message;
            el.className = `result-box show ${success ? 'success' : 'error'}`;
        }

        // Load report
        async function loadReport() {
            const year = document.getElementById('report-year').value;
            const month = document.getElementById('report-month').value;

            document.getElementById('report-content').innerHTML = '<div class="loading">Loading...</div>';

            try {
                const [cashRes, accrualRes] = await Promise.all([
                    fetch(`/api/report/cash-flow?year=${year}&month=${month}`),
                    fetch(`/api/report/accrual?year=${year}&month=${month}`)
                ]);

                const cashData = await cashRes.json();
                const accrualData = await accrualRes.json();

                if (cashData.success && accrualData.success) {
                    const cash = cashData.data.summary;
                    const accrual = accrualData.data.summary;

                    document.getElementById('report-content').innerHTML = `
                        <div class="stats-grid">
                            <div class="stat-card green">
                                <h3>Income</h3>
                                <div class="value">${cash.total_income.toLocaleString()}</div>
                                <div class="unit">$</div>
                            </div>
                            <div class="stat-card orange">
                                <h3>Cash Spent</h3>
                                <div class="value">${cash.total_outflow.toLocaleString()}</div>
                                <div class="unit">$</div>
                            </div>
                            <div class="stat-card blue">
                                <h3>True Living Cost</h3>
                                <div class="value">${accrual.true_living_cost.toLocaleString()}</div>
                                <div class="unit">$</div>
                            </div>
                            <div class="stat-card">
                                <h3>Daily Cost</h3>
                                <div class="value">${accrual.daily_cost.toFixed(2)}</div>
                                <div class="unit">$/day</div>
                            </div>
                        </div>

                        <h3 style="margin-top:30px; margin-bottom:15px;">Expense Breakdown</h3>
                        <table>
                            <tr><td>Daily Expenses</td><td style="text-align:right">$${cash.total_expense.toLocaleString()}</td></tr>
                            <tr><td>Big Purchases</td><td style="text-align:right">$${cash.total_capital.toLocaleString()}</td></tr>
                            <tr><td>Monthly Depreciation</td><td style="text-align:right">$${accrual.total_depreciation.toLocaleString()}</td></tr>
                        </table>

                        <div class="insight-box">
                            <h4>Monthly Insight</h4>
                            <p>You actually spent $${cash.total_outflow.toLocaleString()}, but your "true living cost" is only $${accrual.true_living_cost.toLocaleString()}.
                            ${cash.total_capital > 0 ? 'This is because you made big purchases this month, and their cost will spread over the coming years.' : ''}
                            To maintain your current lifestyle, you need about $${accrual.daily_cost.toFixed(2)} per day.</p>
                        </div>
                    `;
                }
            } catch (e) {
                document.getElementById('report-content').innerHTML = '<div class="loading">Failed to load</div>';
            }
        }

        // Load comparison
        async function loadCompare() {
            const year = document.getElementById('compare-year').value;
            const month = document.getElementById('compare-month').value;

            document.getElementById('compare-content').innerHTML = '<div class="loading">Loading...</div>';

            try {
                const res = await fetch(`/api/report/compare?year=${year}&month=${month}`);
                const data = await res.json();

                if (data.success) {
                    const d = data.data;
                    document.getElementById('compare-content').innerHTML = `
                        <div class="compare-section">
                            <div class="compare-card cash">
                                <h4>Cash Basis</h4>
                                <div class="amount">$${d.cash_flow.total_outflow.toLocaleString()}</div>
                                <div class="desc">Actual money spent</div>
                            </div>
                            <div class="compare-card accrual">
                                <h4>Accrual Basis</h4>
                                <div class="amount">$${d.accrual.true_living_cost.toLocaleString()}</div>
                                <div class="desc">True living cost</div>
                            </div>
                        </div>

                        <div class="insight-box">
                            <h4>Analysis</h4>
                            <p>${d.difference.explanation}</p>
                        </div>
                    `;
                }
            } catch (e) {
                document.getElementById('compare-content').innerHTML = '<div class="loading">Failed to load</div>';
            }
        }

        // Load assets
        async function loadAssets() {
            try {
                const [assetsRes, balanceRes] = await Promise.all([
                    fetch('/api/assets'),
                    fetch('/api/report/balance')
                ]);

                const assetsData = await assetsRes.json();
                const balanceData = await balanceRes.json();

                if (balanceData.success) {
                    const s = balanceData.data.summary;
                    document.getElementById('assets-summary').innerHTML = `
                        <div class="stat-card">
                            <h3>Asset Count</h3>
                            <div class="value">${s.asset_count}</div>
                            <div class="unit">items</div>
                        </div>
                        <div class="stat-card green">
                            <h3>Original Value</h3>
                            <div class="value">${s.total_original_cost.toLocaleString()}</div>
                            <div class="unit">$</div>
                        </div>
                        <div class="stat-card blue">
                            <h3>Current Value</h3>
                            <div class="value">${s.total_current_value.toLocaleString()}</div>
                            <div class="unit">$</div>
                        </div>
                        <div class="stat-card orange">
                            <h3>Accumulated Depreciation</h3>
                            <div class="value">${s.total_accumulated_depreciation.toLocaleString()}</div>
                            <div class="unit">$</div>
                        </div>
                    `;
                }

                if (assetsData.success) {
                    const tbody = document.getElementById('assets-tbody');
                    tbody.innerHTML = assetsData.data.map(a => `
                        <tr>
                            <td>${a.name}</td>
                            <td>$${a.original_cost.toLocaleString()}</td>
                            <td>$${a.current_value.toLocaleString()}</td>
                            <td>$${a.monthly_depreciation.toFixed(2)}</td>
                            <td>${a.remaining_months} months</td>
                            <td>${a.purchase_date}</td>
                        </tr>
                    `).join('');

                    if (assetsData.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#999;">No assets recorded</td></tr>';
                    }
                }
            } catch (e) {
                console.error(e);
            }
        }

        // Load transactions
        async function loadTransactions() {
            try {
                const res = await fetch('/api/transactions');
                const data = await res.json();

                if (data.success) {
                    const tbody = document.getElementById('transactions-tbody');
                    const typeMap = {
                        'income': { label: 'Income', class: 'tag-income' },
                        'expense': { label: 'Expense', class: 'tag-expense' },
                        'capital': { label: 'Capital', class: 'tag-capital' }
                    };

                    tbody.innerHTML = data.data.map(t => {
                        const type = typeMap[t.transaction_type] || { label: t.transaction_type, class: '' };
                        const sign = t.transaction_type === 'income' ? '+' : '-';
                        return `
                            <tr>
                                <td>${t.transaction_date}</td>
                                <td>${t.description}</td>
                                <td><span class="tag ${type.class}">${type.label}</span></td>
                                <td>${t.category}</td>
                                <td style="color: ${t.transaction_type === 'income' ? '#28a745' : '#dc3545'}">${sign}$${t.amount.toLocaleString()}</td>
                            </tr>
                        `;
                    }).join('');

                    if (data.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#999;">No transactions recorded</td></tr>';
                    }
                }
            } catch (e) {
                console.error(e);
            }
        }
    </script>
</body>
</html>
